<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner with Price</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .video-container {
            width: 100%;
            max-width: 400px; /* Limit video width for better aspect ratio */
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        #reader {
            width: 100%;
            height: auto;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .button-primary:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .button-secondary {
            background-color: #e2e8f0;
            color: #334155;
        }
        .button-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .list-container {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            max-height: 250px;
            overflow-y: auto;
        }
        .list-item {
            padding: 8px 0;
            border-bottom: 1px dashed #cbd5e1;
            color: #334155;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .no-items {
            color: #64748b;
            text-align: center;
            padding: 20px;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .modal-close-button:hover {
            color: #334155;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-buttons .button {
            flex: 1;
            max-width: 150px;
        }
        .price-input-group {
            margin-top: 15px;
            text-align: left;
        }
        .price-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #334155;
        }
        .price-input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Barcode Scanner</h1>

        <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-1 flex flex-col items-center">
                <div class="mb-4 w-full max-w-xs">
                    <label for="camera-select" class="block text-sm font-medium text-gray-700 mb-2">Select Camera:</label>
                    <select id="camera-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        </select>
                </div>

                <div class="video-container">
                    <div id="reader"></div>
                </div>

                <div class="button-group mt-4">
                    <button id="start-scan-button" class="button button-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 12a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H4zM14 2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2h-2zm0 12a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" clip-rule="evenodd" />
                        </svg>
                        Start Scanning
                    </button>
                    <button id="stop-scan-button" class="button button-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        Stop Scanning
                    </button>
                </div>
            </div>

            <div class="flex-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Scanned Codes</h2>
                <div id="scanned-codes-list" class="list-container">
                    <p class="no-items" id="no-items-message">No codes scanned yet.</p>
                </div>

                <div class="button-group mt-4">
                    <button id="clear-list-button" class="button button-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                        Clear List
                    </button>
                    <button id="download-json-button" class="button button-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M.5 8a.5.5 0 0 1 .5.5V12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V8.5a.5.5 0 0 1 1 0V12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V8.5A.5.5 0 0 1 .5 8z"/>
                            <path fill-rule="evenodd" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download JSON
                    </button>
                    <button id="copy-clipboard-button" class="button button-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5z"/>
                            <path d="M11 3a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5a2 2 0 012-2h2zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 11a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2a2 2 0 012-2h2z"/>
                        </svg>
                        Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="hideModal('confirmation-modal')">&times;</button>
            <p id="modal-message" class="text-lg text-gray-800 mb-4"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-button" class="button button-primary">Confirm</button>
                <button id="modal-cancel-button" class="button button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="price-input-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Enter Price</h3>
            <p class="text-gray-700 mb-4">Scanned Code: <strong id="scanned-code-display"></strong></p>
            <div class="price-input-group">
                <label for="price-input">Price (optional):</label>
                <input type="number" id="price-input" step="0.01" placeholder="e.g., 19.99">
            </div>
            <div class="modal-buttons mt-6">
                <button id="save-price-button" class="button button-primary">Save Price</button>
                <button id="skip-price-button" class="button button-secondary">Skip Price</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Html5Qrcode with the reader element ID
        const html5QrCode = new Html5Qrcode("reader");
        // Array to store scanned codes as objects { code: string, price: string, timestamp: string }
        let scannedCodes = [];
        const localStorageKey = 'scannedBarcodes';
        let currentScannedCode = null; // To hold the code while price is being entered

        // Get references to DOM elements
        const cameraSelect = document.getElementById('camera-select');
        const startScanButton = document.getElementById('start-scan-button');
        const stopScanButton = document.getElementById('stop-scan-button');
        const clearListButton = document.getElementById('clear-list-button');
        const downloadJsonButton = document.getElementById('download-json-button');
        const copyClipboardButton = document.getElementById('copy-clipboard-button');
        const scannedCodesListDiv = document.getElementById('scanned-codes-list');
        const noItemsMessage = document.getElementById('no-items-message');
        const messageBox = document.getElementById('message-box');

        // Confirmation Modal elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        // Price Input Modal elements
        const priceInputModal = document.getElementById('price-input-modal');
        const scannedCodeDisplay = document.getElementById('scanned-code-display');
        const priceInput = document.getElementById('price-input');
        const savePriceButton = document.getElementById('save-price-button');
        const skipPriceButton = document.getElementById('skip-price-button');

        // Function to show a message box for temporary notifications
        function showMessageBox(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Function to show a custom confirmation modal
        function showModal(id, message, onConfirm) {
            const modal = document.getElementById(id);
            modalMessage.textContent = message;
            modal.classList.add('show');

            // Clear previous event listeners to prevent multiple calls
            modalConfirmButton.onclick = null;
            modalCancelButton.onclick = null;

            // Set new event listeners for confirm and cancel actions
            modalConfirmButton.onclick = () => {
                onConfirm(); // Execute the provided confirmation callback
                hideModal(id); // Hide the modal after confirmation
            };
            modalCancelButton.onclick = () => {
                hideModal(id); // Hide the modal on cancellation
            };
        }

        // Function to hide a custom modal
        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // Load scanned codes from localStorage when the app starts
        function loadCodes() {
            const storedCodes = localStorage.getItem(localStorageKey);
            if (storedCodes) {
                // Parse the JSON string back into an array
                scannedCodes = JSON.parse(storedCodes);
            }
            renderScannedCodes(); // Update the displayed list
        }

        // Save current scanned codes to localStorage
        function saveCodes() {
            // Convert the array to a JSON string before saving
            localStorage.setItem(localStorageKey, JSON.stringify(scannedCodes));
            renderScannedCodes(); // Update the displayed list after saving
        }

        // Render (display) the scanned codes in the list area
        function renderScannedCodes() {
            scannedCodesListDiv.innerHTML = ''; // Clear current list display
            if (scannedCodes.length === 0) {
                // Show "No items" message if the list is empty
                noItemsMessage.style.display = 'block';
                scannedCodesListDiv.appendChild(noItemsMessage);
            } else {
                // Hide "No items" message and populate the list
                noItemsMessage.style.display = 'none';
                scannedCodes.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    const priceText = item.price ? ` (${parseFloat(item.price).toFixed(2)})` : '';
                    const timestampText = item.timestamp ? ` - ${item.timestamp}` : '';
                    // Add the scanned code, price, timestamp and a delete button for each item
                    listItem.innerHTML = `
                        <span>${item.code}${priceText}${timestampText}</span>
                        <button class="text-red-500 hover:text-red-700 ml-4" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    scannedCodesListDiv.appendChild(listItem);
                });
            }
        }

        // Callback function for successful barcode scans
        const onScanSuccess = (decodedText, decodedResult) => {
            // Check if the code (decodedText) already exists in the list
            // We only check the 'code' property of the objects in scannedCodes
            const exists = scannedCodes.some(item => item.code === decodedText);

            if (!exists) {
                currentScannedCode = decodedText; // Store the scanned code temporarily
                scannedCodeDisplay.textContent = decodedText; // Display in the price modal
                priceInput.value = ''; // Clear previous price input
                priceInputModal.classList.add('show'); // Show the price input modal
                // Stop scanning temporarily until price is entered or skipped
                html5QrCode.pause();
            } else {
                showMessageBox(`Code already scanned: ${decodedText}`);
            }
        };

        // Callback function for barcode scan errors (can be ignored for minor errors)
        const onScanError = (errorMessage) => {
            // console.warn(`QR Code scanning error: ${errorMessage}`);
        };

        // Populate the camera dropdown with available cameras
        // getCameras is a static method of the Html5Qrcode class.
        Html5Qrcode.getCameras().then(cameras => {
            if (cameras.length > 0) {
                // Add each camera as an option in the select dropdown
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.textContent = camera.label;
                    cameraSelect.appendChild(option);
                });
                startScanButton.disabled = false; // Enable start button if cameras are found
            } else {
                showMessageBox("No cameras found on this device.");
                startScanButton.disabled = true; // Disable start button if no cameras
            }
        }).catch(err => {
            showMessageBox(`Error getting cameras: ${err.message}`);
            startScanButton.disabled = true; // Disable start button on error
        });

        // Event listener for the "Start Scanning" button
        startScanButton.addEventListener('click', () => {
            const selectedCameraId = cameraSelect.value;
            if (selectedCameraId) {
                // Start the QR code scanner with the selected camera
                html5QrCode.start(
                    selectedCameraId,
                    {
                        fps: 10, // Frames per second
                        qrbox: (width, height) => { // Define the scanning box size
                            const minDimension = Math.min(width, height);
                            return { width: minDimension * 0.8, height: minDimension * 0.8 };
                        },
                        aspectRatio: 1.777778 // 16:9 aspect ratio for the video feed
                    },
                    onScanSuccess, // Callback for successful scan
                    onScanError // Callback for scan errors
                ).then(() => {
                    showMessageBox("Scanning started.");
                    startScanButton.disabled = true; // Disable start button
                    stopScanButton.disabled = false; // Enable stop button
                    cameraSelect.disabled = true; // Disable camera selection during scan
                }).catch(err => {
                    showMessageBox(`Unable to start scanning: ${err.message}`);
                });
            } else {
                showMessageBox("Please select a camera.");
            }
        });

        // Event listener for the "Stop Scanning" button
        stopScanButton.addEventListener('click', () => {
            html5QrCode.stop().then(() => {
                showMessageBox("Scanning stopped.");
                startScanButton.disabled = false; // Enable start button
                stopScanButton.disabled = true; // Disable stop button
                cameraSelect.disabled = false; // Enable camera selection
            }).catch(err => {
                showMessageBox(`Error stopping scanning: ${err.message}`);
            });
        });

        // Event listener for the "Save Price" button in the price input modal
        savePriceButton.addEventListener('click', () => {
            const price = priceInput.value.trim();
            if (currentScannedCode) {
                scannedCodes.push({
                    code: currentScannedCode,
                    price: price,
                    timestamp: new Date().toLocaleString()
                });
                saveCodes();
                showMessageBox(`Added: ${currentScannedCode} with price ${price || 'N/A'}`);
                hideModal('price-input-modal');
                html5QrCode.resume(); // Resume scanning
                currentScannedCode = null; // Clear temporary code
            }
        });

        // Event listener for the "Skip Price" button in the price input modal
        skipPriceButton.addEventListener('click', () => {
            if (currentScannedCode) {
                scannedCodes.push({
                    code: currentScannedCode,
                    price: null, // Store price as null if skipped
                    timestamp: new Date().toLocaleString()
                });
                saveCodes();
                showMessageBox(`Added: ${currentScannedCode} (no price)`);
                hideModal('price-input-modal');
                html5QrCode.resume(); // Resume scanning
                currentScannedCode = null; // Clear temporary code
            }
        });

        // Event listener for the "Clear List" button
        clearListButton.addEventListener('click', () => {
            if (scannedCodes.length === 0) {
                showMessageBox("List is already empty.");
                return;
            }
            // Show confirmation modal before clearing the list
            showModal('confirmation-modal', 'Are you sure you want to clear all scanned codes?', () => {
                scannedCodes = []; // Clear the array
                saveCodes(); // Save the empty list to localStorage
                showMessageBox("List cleared."); // Notify the user
            });
        });

        // Event listener for the "Download JSON" button
        downloadJsonButton.addEventListener('click', () => {
            if (scannedCodes.length === 0) {
                showMessageBox("No codes to download.");
                return;
            }
            // Convert the scanned codes array to a JSON string with pretty printing
            const dataStr = JSON.stringify(scannedCodes, null, 2);
            // Create a Blob object with the JSON data
            const blob = new Blob([dataStr], { type: "application/json" });
            // Create a URL for the Blob
            const url = URL.createObjectURL(blob);
            // Create a temporary anchor element for downloading
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scanned_barcodes.json'; // Set the download filename
            document.body.appendChild(a); // Append to body (required for Firefox)
            a.click(); // Programmatically click the link to trigger download
            document.body.removeChild(a); // Remove the temporary link
            URL.revokeObjectURL(url); // Clean up the Blob URL
            showMessageBox("JSON downloaded."); // Notify the user
        });

        // Event listener for the "Copy to Clipboard" button
        copyClipboardButton.addEventListener('click', () => {
            if (scannedCodes.length === 0) {
                showMessageBox("No codes to copy.");
                return;
            }
            // Format each item as "Code: [code], Price: [price], Timestamp: [timestamp]"
            const textToCopy = scannedCodes.map(item => {
                const pricePart = item.price ? `, Price: ${parseFloat(item.price).toFixed(2)}` : ', Price: N/A';
                const timestampPart = item.timestamp ? `, Scanned: ${item.timestamp}` : '';
                return `Code: ${item.code}${pricePart}${timestampPart}`;
            }).join('\n');

            // Create a temporary textarea element to hold the text
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select(); // Select the text in the textarea
            try {
                // Execute the copy command (deprecated but widely supported)
                document.execCommand('copy');
                showMessageBox("Codes copied to clipboard!");
            } catch (err) {
                showMessageBox("Failed to copy codes. Please try manually.");
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea); // Remove the temporary textarea
        });

        // Event listener for removing individual items from the list
        scannedCodesListDiv.addEventListener('click', (event) => {
            // Check if a button within a list item was clicked
            if (event.target.closest('button')) {
                const button = event.target.closest('button');
                // Get the index of the item to be removed from the data-index attribute
                const index = parseInt(button.dataset.index);
                if (!isNaN(index)) {
                    // Show confirmation modal before removing an individual item
                    showModal('confirmation-modal', `Are you sure you want to remove "${scannedCodes[index].code}"?`, () => {
                        scannedCodes.splice(index, 1); // Remove the item from the array
                        saveCodes(); // Save the updated list
                        showMessageBox("Code removed."); // Notify the user
                    });
                }
            }
        });

        // Initial setup when the page loads
        loadCodes(); // Load any previously scanned codes
        stopScanButton.disabled = true; // Initially disable the stop button as scanning hasn't started
    </script>
</body>
</html>
